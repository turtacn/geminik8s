#!/bin/bash
# gemin_k8s-demo : æ¼”ç¤º Dual-Node Kubernetes HA CLI
# ç‰¹è‰²ï¼šä¸“ä¸šã€åˆ›æ–°ã€ä½“éªŒä¼˜äº kubectl

# å½©è‰²è¾“å‡ºå®šä¹‰
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m' # No Color

function step() {
  echo -e "\n${BLUE}â–¶ $1${NC}"
  sleep 1
}

function progress() {
  for i in {1..20}; do
    bar=$(printf "%-${i}s" "#" | tr ' ' '#')
    echo -ne "   [${GREEN}${bar}${NC}$(printf "%$((20-i))s" "")] $((i*5))%\r"
    sleep 0.1
  done
  echo ""
}

echo -e "${GREEN}ğŸš€ geminik8s - Dual-Node Kubernetes HA Solution Demo${NC}"
echo "======================================================"
echo ""

step "æ£€æŸ¥ç‰ˆæœ¬ä¿¡æ¯"
echo "\$ gemin_k8s version"
echo -e "geminik8s version ${GREEN}v1.0.0${NC}"
echo "Built with: go1.21.5"
echo "Platform: linux/amd64"

step "åˆå§‹åŒ–åŒèŠ‚ç‚¹é›†ç¾¤é…ç½®"
echo "\$ gemin_k8s init --name demo-cluster --node1-ip 192.168.1.10 --node2-ip 192.168.1.11 --vip 192.168.1.100"
progress
echo -e "${GREEN}âœ… Generated node1 configuration${NC}"
echo -e "${GREEN}âœ… Generated node2 configuration${NC}"
echo -e "${GREEN}âœ… Created virtual IP configuration${NC}"
echo -e "${GREEN}âœ… PostgreSQL replication setup ready${NC}"
echo -e "ğŸ“ Configuration saved to: ./demo-cluster/"

step "éƒ¨ç½²é›†ç¾¤"
echo "\$ gemin_k8s deploy --config-dir ./demo-cluster --bootstrap-leader node1"
echo -e "${YELLOW}ğŸ”§ Deploying dual-node cluster...${NC}"
progress
echo "ğŸ“¦ Installing K8s on node1 (192.168.1.10)..."
sleep 1
echo "ğŸ“¦ Installing K8s on node2 (192.168.1.11)..."
sleep 1
echo "ğŸ—ƒï¸  Setting up PostgreSQL + Kine..."
sleep 1
echo "ğŸ”„ Configuring leader election..."
sleep 1
echo -e "${GREEN}âœ… Cluster deployed successfully!${NC}"

step "æŸ¥çœ‹é›†ç¾¤çŠ¶æ€"
echo "\$ gemin_k8s status --cluster demo-cluster --details"
sleep 1
cat << STATUS
ğŸ¥ Cluster Health Report
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 Cluster : demo-cluster
 Status  : ${GREEN}ğŸŸ¢ Healthy${NC}
 Nodes   :
   â€¢ node1 (192.168.1.10)  Role: Leader    ğŸŸ¢ Ready   Uptime: 3h45m
   â€¢ node2 (192.168.1.11)  Role: Follower  ğŸŸ¢ Ready   Uptime: 3h44m
 VIP     : 192.168.1.100 (bound to node1)
 Database: PostgreSQL + Kine
   â€¢ Replication : ${GREEN}Active${NC} (lag <100ms)
   â€¢ Failover SLA: <5s
 Kubernetes:
   â€¢ Version : v1.28.0
   â€¢ Nodes   : 2/2 Ready
   â€¢ Pods    : 37 Running / 0 Failed
 Innovation:
   â€¢ Dual-node HA reduces infra cost by ${GREEN}33%${NC}
   â€¢ Replaces etcd with PostgreSQL (simpler ops)
   â€¢ Built-in A/B OS rollback for zero-downtime upgrades
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
STATUS

step "æ‰§è¡Œæ‰‹åŠ¨æ•…éšœè½¬ç§»"
echo "\$ gemin_k8s failover --cluster demo-cluster --promote node2"
echo -e "${YELLOW}âš¡ Initiating controlled failover...${NC}"
progress
echo "ğŸ”„ Promoting node2 to leader..."
sleep 1
echo "ğŸ“Š Updating PostgreSQL replication..."
sleep 1
echo "ğŸ”€ Switching VIP to node2..."
sleep 1
echo -e "${GREEN}âœ… Failover completed in 4.2s${NC}"
cat << FAILOVER
ğŸ¥ New cluster state:
â”œâ”€â”€ Leader  : node2 (192.168.1.11) ${GREEN}ğŸŸ¢${NC}
â””â”€â”€ Follower: node1 (192.168.1.10) ${GREEN}ğŸŸ¢${NC}
FAILOVER

step "æ‰§è¡Œå‡çº§æ¼”ç¤º"
echo "\$ gemin_k8s upgrade --cluster demo-cluster --version v1.29.0 --strategy rolling"
echo "â¬†ï¸  Preparing upgrade..."
progress
echo "ğŸ“¦ Pulling new Kairos OS image..."
echo "ğŸ”„ Upgrading node1..."
sleep 2
echo "ğŸ”„ Upgrading node2..."
sleep 2
echo -e "${GREEN}âœ… Upgrade completed to Kubernetes v1.29.0${NC}"

step "æ‰§è¡Œå¤‡ä»½ä¸æ¢å¤"
echo "\$ gemin_k8s backup --cluster demo-cluster --output backup-2025-08-18.tar.gz --compress"
echo -e "${GREEN}âœ… Backup completed (compressed, encrypted)${NC}"
echo "\$ gemin_k8s restore --cluster demo-cluster --backup-file backup-2025-08-18.tar.gz --verify"
echo -e "${GREEN}âœ… Restore verified successfully${NC}"

step "æ›¿æ¢èŠ‚ç‚¹æ¼”ç¤º"
echo "\$ gemin_k8s replace-node --cluster demo-cluster --old-node node1 --new-node-ip 192.168.1.12 --preserve-data"
echo "ğŸ”„ Draining old node..."
progress
echo "ğŸ“¦ Installing K8s on new node..."
sleep 1
echo -e "${GREEN}âœ… Node replacement completed${NC}"

step "æ€»ç»“"
echo "ğŸ’¡ Demo completed! Key features demonstrated:"
echo -e "   ${GREEN}âœ… Cost-effective dual-node setup (33% cost reduction)${NC}"
echo -e "   ${GREEN}âœ… Automatic failover in seconds${NC}"
echo -e "   ${GREEN}âœ… PostgreSQL-backed storage (no etcd complexity)${NC}"
echo -e "   ${GREEN}âœ… Rolling upgrades with auto-rollback${NC}"
echo -e "   ${GREEN}âœ… Data backup & restore built-in${NC}"
echo -e "   ${GREEN}âœ… Production-ready high availability${NC}"
echo ""
echo "ğŸ“– Learn more: https://github.com/turtacn/geminik8s"
